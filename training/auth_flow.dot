# Turn this into auth_flow.dot.pdf using Graphviz:
# dot auth_flow.dot -Tpdf -O
digraph
{
        start[label=Start style=filled fillcolor="#04ff04"]

        node [shape=ellipse, style=filled, fillcolor="#ff9090"]
        o_noapikey[label="Raise 'invalid API key' alarm,\nreturn 401"]
        o_badprint[label="Raise 'incorrect fingerprint' alarm,\nreturn 401"]
        o_badip[label="Raise 'bad source IP' alarm,\nreturn 401"]
        o_disabled[label="Return 403"]
        o_clientquit[label="Their client faults,\nour server logs all it can\n(which isn't much)"]

        node [shape=box, style=""]
        op1[label="Client connects, server sends its certificate"]
        o_reqclientcert[label="Server requests client certificate.\n(TLS step one)"]
        o_clientsendscert[label="Client sends its certificate"]
        o_clientreq[label="Client sends API request\nincluding API key"]
        o_argcheck[label="Proceed to argument checks\nand execution" style=filled fillcolor="#04ff04"]

        node [shape=diamond]
        cond[label="Client accepts server cert?" ordering=out ]
        c_apikeycheck[label="Is there a REST Client item\nwith that API key?"]
        c_versioncheck [label="What version is the server?" ]
        c_clientcertcheck1[label="Is there a fingerprint\non that REST Client item?"]
        c_clientcertcheck2[label="Does the server allow clients with no key?\n('Enable REST Clients with no client certificate'\nserver property on)"]

        c_clientcertcheck840[label="Does the server ignore client certs?\n('Require pinned client certificates'\nserver property off)"]

        c_correctcert[label="Does the client certificate match\nthe client item's fingerprint?" shape=diamond]
        c_sourceip[label="Client item has IP restrictions,\nand the client does not meet them?" ordering=out ]
        c_disabled[label="Client item is disabled\n(8.90 or later)?" ordering=out ]
        c_licence[label="Server has licence\nfor requested operation?"]
        c_privcheck[label="Operator has privilege\nfor requested operation?"]

        start->op1
        op1->cond
        cond->o_reqclientcert [label = "yes"]
        cond->o_clientquit [label = "no"]
        o_reqclientcert -> o_clientsendscert
        o_clientsendscert -> o_clientreq
        o_clientreq->c_apikeycheck

        c_apikeycheck->c_versioncheck [label = "yes"]
        c_apikeycheck->o_noapikey [label = "no"]

        c_versioncheck -> c_clientcertcheck1 [label = "8.50 or later"]
        c_versioncheck -> c_clientcertcheck840 [label = "before 8.50"]

        c_clientcertcheck1->c_clientcertcheck2 [label= "no"]

        c_clientcertcheck840->c_sourceip [label = "yes"]
        c_clientcertcheck840->c_correctcert [label = "no"]

        c_clientcertcheck2->c_sourceip [label = "yes"]
        c_clientcertcheck2->o_badprint [label = "no"]

        c_clientcertcheck1->c_correctcert [label = "yes"]
        c_correctcert->o_badprint [label = "no"]

        c_correctcert->c_sourceip [label = "yes"]
        c_sourceip->c_disabled [label = "no"]
        c_sourceip->o_badip [label = "yes"]

        c_disabled->c_licence [label = "no"]
        c_disabled->o_disabled [label = "yes"]

        c_licence->c_privcheck [label="yes"]
        c_licence->o_disabled [label="no"]
        c_privcheck->o_disabled [label="no"]
        c_privcheck->o_argcheck [label="yes"]
}
